{%- liquid
  assign animation_name = 'drawer-items-fade'
  assign animation_duration = 500
  assign animation_delay_min = 50
  assign animation_delay_additional = 200
  assign highlight_item = highlight_item | downcase | strip_html | escape
  assign link_title_lowercase = link.title | downcase | strip_html | escape
  assign expands = false
  assign block_count = 0
  assign link_level = link_level | default: 0
  assign link_level_next = link_level | plus: 1
  assign forloop_index = forloop_index | default: 1

  if section
    assign index = index | append: ""
    for block in section.blocks
      if block.settings.position == index
        assign block_count = block_count | plus: 1
      endif
    endfor
  endif

  if link.levels > 0 or block_count > 0
    assign expands = true
    assign key = link.url | append: link.title | append: link.levels | append: index | md5
  endif

  if secondary_menu
    assign expands = false
  endif
-%}

<div class="sliderule__wrapper{% if secondary_menu %} sliderule__wrapper--secondary{% endif %}" data-level="{{ link_level }}">
  {%- if expands -%}
    {%- comment -%} Parent title - styled as non-clickable header {%- endcomment -%}
    <div class="sliderow sliderow--static-header sliderow--level-{{ link_level }}"
      data-animates="{{ link_level }}"
      data-animation="{{ animation_name }}"
      data-animation-delay="{{ animation_delay | plus: animation_delay_additional }}"
      data-animation-duration="{{ animation_duration }}">
      <span class="sliderow__title sliderow__title--parent{% if secondary_menu %} sliderow__title--secondary{% endif %}{% if highlight_item == link_title_lowercase %} sliderow__title--highlight{% endif %}">
        {{ link.title | strip_html | escape }}
      </span>
    </div>

    {%- comment -%} Subcategories - inline, no panel {%- endcomment -%}
    <div class="sliderow__children sliderow__children--level-{{ link_level_next }}"
      data-animates="{{ link_level }}"
      data-animation="{{ animation_name }}"
      data-animation-delay="{{ animation_delay | plus: animation_delay_additional | plus: 50 }}"
      data-animation-duration="{{ animation_duration }}">
      
      {%- for child_link in link.links -%}
        {%- assign child_title_lowercase = child_link.title | downcase | strip_html | escape -%}
        {%- assign child_has_children = false -%}
        {%- if child_link.links.size > 0 -%}
          {%- assign child_has_children = true -%}
        {%- endif -%}

        {%- if child_has_children -%}
          {%- comment -%} Nested level - render recursively {%- endcomment -%}
          {%- assign child_index = index | append: 'x' | append: forloop.index -%}
          {%- assign child_animation_delay = 50 | times: forloop.index -%}
          {%- render 'nav-item-mobile', link: child_link, index: child_index, forloop_index: forloop.index, link_level: link_level_next, highlight_item: highlight_item, animation_delay: child_animation_delay -%}
        {%- else -%}
          {%- comment -%} Simple child link {%- endcomment -%}
          <div class="sliderow sliderow--child sliderow--level-{{ link_level_next }}">
            <a class="sliderow__title sliderow__title--child{% if highlight_item == child_title_lowercase %} sliderow__title--highlight{% endif %}" href="{{ child_link.url }}">
              {{ child_link.title | strip_html | escape }}
            </a>
          </div>
        {%- endif -%}
      {%- endfor -%}

      {%- comment -%} Render block content if any {%- endcomment -%}
      {%- if section and section.blocks.size > 0 -%}
        {%- assign header_blocks = '' -%}
        {%- assign animation_delay_next = 50 -%}
        {%- assign block_animation_delay = animation_delay | plus: animation_delay_additional -%}

        {% for block in section.blocks %}
          {%- if block.settings.position == index -%}
            {%- assign block_animation_delay = block_animation_delay | plus: animation_delay_next -%}
            {%- capture header_blocks -%}
              {{ header_blocks }}
              {% render 'header-block', block: block, link_level_next: link_level_next, animation_delay: block_animation_delay, is_mobile: true %}
            {%- endcapture -%}
          {%- endif -%}
        {% endfor %}

        {%- if header_blocks != '' -%}
          <div class="sliderule-grid blocks-{{ block_count }}">
            {{ header_blocks }}
          </div>
        {%- endif -%}
      {%- endif -%}
    </div>
    
    {%- if link_title_lowercase == "formal shirts" -%}
      <div class="sliderow__divider"></div>
    {%- endif -%}

  {%- else -%}
    {%- comment -%} Single menu item, no nesting {%- endcomment -%}
    <div class="sliderow sliderow--level-{{ link_level }}"
      role="button"
      data-animates="{{ link_level }}"
      data-animation="{{ animation_name }}"
      data-animation-delay="{{ animation_delay | plus: animation_delay_additional }}"
      data-animation-duration="{{ animation_duration }}">
      {%- if link.url == "#" -%}
        <span class="sliderow__title{% if secondary_menu %} sliderow__title--secondary{% endif %}{% if highlight_item == link_title_lowercase %} sliderow__title--highlight{% endif %}">{{ link.title | strip_html | escape }}</span>
      {%- else -%}
        <a class="sliderow__title{% if secondary_menu %} sliderow__title--secondary{% endif %}{% if highlight_item == link_title_lowercase %} sliderow__title--highlight{% endif %}" href="{{ link.url }}">{{ link.title | strip_html | escape }}</a>
      {%- endif -%}
    </div>
    
    {%- if link_title_lowercase == "formal shirts" -%}
      <div class="sliderow__divider"></div>
    {%- endif -%}
  {%- endif -%}
</div>